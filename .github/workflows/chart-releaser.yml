name: Release Charts

on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v1
        # with:
        #   version: v3.4.0

      - name: Helm Dependency update
        run: |

          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add bioanalyze https://dabble-of-devops-bioanalyze.github.io/helm-charts/
          helm repo update

          cd charts/shinyproxy
          helm dep update
          helm dep build

          cd ../../charts/cellxgene-gateway
          helm dep update
          helm dep build

      # "arn:aws:ecr:us-east-1:018835827632:repository/shinyproxy"
      # "018835827632.dkr.ecr.us-east-1.amazonaws.com/helm-shinyproxy"
      # 018835827632.dkr.ecr.us-east-1.amazonaws.com/helm-cellxgene-gateway
      # Helm chart name must be the same as the repo name
      # 018835827632.dkr.ecr.us-east-1.amazonaws.com/cellxgene-gateway
      # 018835827632.dkr.ecr.us-east-1.amazonaws.com/shinyproxy
      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.2.1
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: List packages
        run: |-
          ls -lah .cr-release-packages

      # Helm chart name must be the same as the repo name
      # 018835827632.dkr.ecr.us-east-1.amazonaws.com/cellxgene-gateway
      # 018835827632.dkr.ecr.us-east-1.amazonaws.com/shinyproxy
      - name: Upload to ECR
        run: |-
          export HELM_EXPERIMENTAL_OCI=1

          helm --version
          find .cr-release-packages -name 'shinyproxy*.tgz' | xargs -I {} helm push {} oci://018835827632.dkr.ecr.us-east-1.amazonaws.com/
          find .cr-release-packages -name 'cellxgene-gateway*.tgz' | xargs -I {} helm push {} oci://018835827632.dkr.ecr.us-east-1.amazonaws.com/

          aws ecr describe-images \
            --repository-name shinyproxy \
            --region us-east-1

          aws ecr describe-images \
            --repository-name cellxgene-gateway \
            --region us-east-1